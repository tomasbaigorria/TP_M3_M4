---
title: "TP M3 M4"
author: "Tomás Emilio Baigorria"
date: "2024-03-05"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Preparación y exploración de datos

### Importación de librerías.

```{r, message = FALSE, warning = FALSE}
library(tidyverse)
library(tidymodels)
tidymodels_prefer()
library(GGally)
library(gtsummary)
library(gt)
library(lubridate)
library(ggplot2)
library(scales)
library(paletteer)
library(viridis)
library(corrplot)
```

###Preparación del dataset.

- Renombramos las variables codificadas y eliminamos las columnas que consideramos irrelevantes (CODUSU, y Nro. de Hogar).


```{r, message = FALSE, warning = FALSE}

data_eph <- read_csv("./Data/M34_202103_eph.csv") %>% 
  rename("ROL_HOGAR" = "CH03") %>% 
  rename("SEXO" = "CH04") %>% 
  rename("EDAD" = "CH06") %>%
  rename("ESTADO CONYUGAL" = "CH07") %>%
  rename("SECTOR_PUB_PRIV" = "PP04A") %>%
  rename("CANT_HORAS" = "PP3E_TOT") %>%
  rename("INGRESO_OCUP_PRINCIPAL" = "P21") %>% 
  select(3:15)

```

###Exploración de los datos

- Comenzamos con el estudio de la distribución de nuestra variable objetivo, el ingreso percibido por la ocupación principal:

    - En una primera iteración del gráfico observamos la presencia de un outlier, el cual filtramos excluyendo de la muestra el percentil superior.
    
    - Observamos también la existencia de valores negativos (-9) y nulos, que corresponden a "no respuesta" y a "no les corresponde la secuencia alcanzada", respectivamente. Decidimos quitarlos para obtener datos más homogéneos.
    
    - Luego elaboramos un gráfico de densidad.


```{r}

top10ingresos <- top_n(data_eph %>% select(INGRESO_OCUP_PRINCIPAL), 10) %>% 
  arrange(desc(INGRESO_OCUP_PRINCIPAL))

data_eph_limpio <- data_eph %>% filter(INGRESO_OCUP_PRINCIPAL > 0)

data_eph_limpio %>% 
  select(INGRESO_OCUP_PRINCIPAL) %>%
  filter(INGRESO_OCUP_PRINCIPAL < quantile(INGRESO_OCUP_PRINCIPAL, .99)) %>%
    ggplot(aes(x = INGRESO_OCUP_PRINCIPAL)) +
      geom_density(alpha = 0.4, fill = "lightblue") +
      theme_minimal() +
      scale_y_continuous(labels = comma_format(big.mark = ".", decimal.mark = ",")) +
      scale_x_continuous(labels = comma_format(big.mark = ".", decimal.mark = ",")) +
      ggtitle("Distribución Ingreso por Ocupación Principal") +
      labs(x = "Ingreso por Ocupación Principal",
         y = "Densidad")


#notese la tendencia en los encuestados a decir un valor redondo para el ignreso
```

- A continuación, estudiamos la relación entre el Ingreso y algunas de las variables categóricas presentes en el data set.


```{r}

data_eph_limpio %>% 
  group_by(NIVEL_ED) %>% 
  summarise(ingreso_promedio = mean(INGRESO_OCUP_PRINCIPAL)) %>% 
  arrange(ingreso_promedio) %>% 
  mutate(NIVEL_ED = fct_inorder(NIVEL_ED)) %>% 
  ggplot(aes(x = NIVEL_ED, y = ingreso_promedio, fill = NIVEL_ED)) +
    geom_col() +
    theme_minimal() +
    scale_fill_viridis_d() +
    guides(fill = "none") +
    scale_y_continuous(labels = comma_format(big.mark = ".", decimal.mark = ",")) +
    scale_x_discrete(labels = label_wrap(10)) +
    ggtitle("Ingreso por Ocupación Principal según Nivel Educativo") +
    labs(x = "Nivel Educativo",
         y = "Ingreso por Ocupación Principal")


```

```{r}

lmodel <- linear_reg() %>%
  set_engine("lm")

wflow1 <- workflow() %>% 
  add_model(lmodel) %>% 
  add_formula(INGRESO_OCUP_PRINCIPAL ~ CANT_HORAS +
                                       EDAD +
                                       NIVEL_ED +  
                                       SEXO:CANT_HORAS)                           #mostrar con métricas

fit1 <- fit(wflow1, data_eph_limpio)

fit1 %>% 
  extract_fit_parsnip() %>% 
  tidy()


```


```{r}

augment(fit1, new_data = data_eph_limpio %>% 
          filter(INGRESO_OCUP_PRINCIPAL < quantile(INGRESO_OCUP_PRINCIPAL, .99))) %>% 
  mutate(.resid = INGRESO_OCUP_PRINCIPAL - .pred) %>%
  dplyr::select(INGRESO_OCUP_PRINCIPAL, .pred, .resid) %>%
  #graficamos
  ggplot(aes(y = .pred, x = INGRESO_OCUP_PRINCIPAL, color = .resid)) +
    geom_point() +
    theme_minimal()  +
    geom_abline(
      intercept = 0,
      slope = 1,
      linewidth = 1,
      color = "grey"
    ) +
    scale_color_viridis(option = "C") +
    ylim(0, 175000)


```


```{r}

names(data_eph_limpio) <- gsub(x = names(data_eph_limpio),
                            pattern = "\\_",
                            replacement = " ")

names(data_eph_limpio)

data_eph_limpio <- data_eph_limpio %>% relocate(`INGRESO OCUP PRINCIPAL`)

matriz_corr1 <- c("INGRESO OCUP PRINCIPAL", "NIVEL ED", "SEXO", "CANT HORAS")

ggpairs(data_eph_limpio, #%>% select(!AGLOMERADO & !CATEGORIA), 
        labeller = label_wrap_gen(width = 10), 
        columns = matriz_corr1) +
  theme_minimal() +
  theme(strip.text.x = element_text(size = 10),
        strip.text.y = element_text(size = 10))
  
data_corr <- data_eph_limpio %>% 
  select_if(is.numeric) %>%
  cor() %>% 
  corrplot(tl.col = "black", method = "square")

```










